<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>SsJackX</title>
    <meta name="author" content="SsJackX">
    <meta name="version" content="1.0.0">
    <meta name="keywords" content>
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">SsJackX</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">标签</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">归档</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">关于</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="/images/avatar.jpg" title="SsJackX">
                </a>
            </div>
            
            <div class="author-name">SsJackX</div>
            <div class="author-work">云计算研究与开发</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">福州, 中国</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/ssjackx" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"/>
</svg>

                        </a>
                    
                        <a class="thread-item" href="http://weibo.com/ssjackx" target="_blank" rel="noopener">
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1566654079576" class="icon" viewbox="0 0 1025 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2338" xmlns:xlink="http://www.w3.org/1999/xlink" width="200.1953125" height="200"><defs><style type="text/css"/></defs><path d="M511.9535 63.941187c-247.458725 0-448.062313 200.602588-448.062313 448.061313 0 247.453725 200.603588 448.057313 448.062313 448.057313 247.453725 0 448.052313-200.603588 448.052313-448.057313C960.005813 264.543775 759.407225 63.941187 511.9535 63.941187L511.9535 63.941187zM470.406378 735.326154c-114.514335 0-231.571678-55.497163-231.571678-146.77843 0-47.72214 30.232089-102.906301 82.306241-154.983454 69.523204-69.506204 150.599441-101.167296 181.093531-70.660207 13.454039 13.437039 14.757043 36.716108 6.107018 64.506189-4.504013 13.997041 13.138038 6.244018 13.138038 6.278018 56.197165-23.528069 105.222308-24.916073 123.142361 0.688002 9.562028 13.64204 8.647025 32.776096-0.166 54.950161-4.078012 10.21503 1.256004 11.796035 9.026026 14.129041 31.665093 9.816029 66.907196 33.559098 66.907196 75.400221C720.390111 648.104899 620.530818 735.326154 470.406378 735.326154L470.406378 735.326154zM677.718986 445.086304c3.706011-11.441034 1.385004-24.485072-7.248021-34.0541-8.624025-9.552028-21.373063-13.176039-33.131097-10.693031L637.339867 400.317173c-9.809029 2.137006-19.472057-4.159012-21.575063-13.959041-2.111006-9.838029 4.154012-19.515057 13.985041-21.609063 24.05307-5.111015 50.106147 2.321007 67.748198 21.895064 17.682052 19.575057 22.413066 46.235135 14.853044 69.626204-3.086009 9.573028-13.344039 14.787043-22.904067 11.728034-9.560028-3.095009-14.788043-13.365039-11.706034-22.917067l-0.018 0L677.718986 445.086304zM783.742296 479.324404c-0.004 0.018-0.004 0.06-0.004 0.081-3.599011 11.095033-15.523045 17.16905-26.610078 13.57904-11.133033-3.595011-17.21505-15.489045-13.62504-26.610078l-0.004-0.009c11.027032-34.1401 4.035012-73.082214-21.715064-101.628298-25.772076-28.554084-63.770187-39.461116-98.88529-32.003094-11.420033 2.431007-22.651066-4.856014-25.088074-16.267048-2.444007-11.397033 4.838014-22.638066 16.258048-25.083073l0.021 0c49.359145-10.492031 102.829301 4.829014 139.085407 45.025132C789.439313 376.562103 799.213341 431.303264 783.742296 479.324404L783.742296 479.324404zM783.742296 479.324404" p-id="2339"/><path d="M624.54883 570.13167c-5.924017-59.970176-84.807248-101.273297-176.195516-92.23827-91.371268 9.034026-160.659471 64.97919-154.723453 124.959366 5.936017 60.001176 84.814248 101.304297 176.195516 92.28627C561.213644 686.09901 630.476847 630.149846 624.54883 570.13167L624.54883 570.13167zM528.526548 619.374815c-18.647055 42.179124-72.288212 64.669189-117.792345 49.991146-43.932129-14.176042-62.532183-57.556169-43.298127-96.632283 18.890055-38.315112 68.035199-59.984176 111.517327-48.671143C523.957535 535.692569 546.920602 578.144694 528.526548 619.374815L528.526548 619.374815zM528.526548 619.374815" p-id="2340"/><path d="M435.544276 587.23972c-14.147041-5.932017-32.439095 0.166-41.170121 13.860041-8.838026 13.74904-4.693014 30.126088 9.359027 36.525107 14.254042 6.509019 33.179097 0.329001 42.022123-13.77104 8.680025-14.241042 4.107012-30.511089-10.20603-36.614107L435.544276 587.23972zM435.544276 587.23972" p-id="2341"/><path d="M470.419378 572.780678c-5.428016-2.154006-12.219036 0.457001-15.404045 5.796017-3.090009 5.368016-1.384004 11.484034 4.057012 13.71904 5.534016 2.278007 12.599037-0.350001 15.796046-5.812017C477.9194 580.982702 475.937394 574.798684 470.419378 572.780678L470.419378 572.780678zM470.419378 572.780678" p-id="2342"/></svg>
                        </a>
                    
                        <a class="thread-item" href="https://more.com/ssjackx" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewbox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M21.332 512c0-270.988 219.68-490.666 490.668-490.666s490.666 219.68 490.666 490.666c0 270.988-219.678 490.666-490.666 490.666s-490.666-219.678-490.666-490.666zM960 512c0-247.424-200.576-448-448-448s-448 200.576-448 448c0 247.424 200.576 448 448 448s448-200.576 448-448zM768 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.206 85.332 85.332 85.332zM512 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.206-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332zM255.998 597.332c47.128 0 85.332-38.206 85.332-85.332s-38.204-85.332-85.332-85.332c-47.128 0-85.332 38.204-85.332 85.332s38.204 85.332 85.332 85.332z"/>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/10/19/CephFS-Provisioner-InputOutput-Error/">CephFS Provisioner InputOutput Error</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-10-19T10:01:15.000Z" itemprop="datePublished">2019-10-19</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/ceph/">ceph</a>, <a class="article-tag-link" href="/tags/kubernetes/">kubernetes</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="1-现象"><a href="#1-现象" class="headerlink" title="1 现象"></a>1 现象</h2><p>（1）在kubernetes环境下部署nginx实例并使用cephfs将nginx持久化存储目录挂载至ceph集群；</p>
<p>（2）使用以下指令在nginx实例持久化目录下创建index.html文件并写入“Hello World from CephFS!!!”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m1 example]# kubectl exec -ti nginx-pod1 -- /bin/sh -c &apos;echo Hello World from CephFS!!! &gt; /usr/share/nginx/html/index.html&apos;</span><br><span class="line">/bin/sh: can&apos;t create /usr/share/nginx/html/index.html: I/O error</span><br></pre></td></tr></table></figure>

<p>（3）以上指令执行结果出现“I/O error”，经排查定位持久化存储异常。</p>
<h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2 解决方案"></a>2 解决方案</h2><p>修改Provisioner插件启动参数，部署所用Yaml文件，如下所示：</p>
<blockquote>
<p>修改前</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: cephfs</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: cephfs-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: cephfs-provisioner</span><br><span class="line">        image: &quot;quay.io/external_storage/cephfs-provisioner:latest&quot;</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/cephfs</span><br><span class="line">        - name: PROVISIONER_SECRET_NAMESPACE</span><br><span class="line">          value: cephfs</span><br><span class="line">        command:</span><br><span class="line">        - &quot;/usr/local/bin/cephfs-provisioner&quot;</span><br><span class="line">        args:</span><br><span class="line">        - &quot;-id=cephfs-provisioner-1&quot;</span><br><span class="line">      serviceAccount: cephfs-provisioner</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改后</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: cephfs</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: cephfs-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: cephfs-provisioner</span><br><span class="line">        image: &quot;quay.io/external_storage/cephfs-provisioner:latest&quot;</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/cephfs</span><br><span class="line">        - name: PROVISIONER_SECRET_NAMESPACE</span><br><span class="line">          value: cephfs</span><br><span class="line">        command:</span><br><span class="line">        - &quot;/usr/local/bin/cephfs-provisioner&quot;</span><br><span class="line">        args:</span><br><span class="line">        - &quot;-disable-ceph-namespace-isolation=true&quot; #修改为该参数可解决I/O error问题</span><br><span class="line">      serviceAccount: cephfs-provisioner</span><br></pre></td></tr></table></figure>

<h2 id="3-参考资料"><a href="#3-参考资料" class="headerlink" title="3 参考资料"></a>3 参考资料</h2><p>（1）问题讨论</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes-incubator/external-storage/issues/345</span><br></pre></td></tr></table></figure>

<p>（2）解决问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/BSI-Business-Systems-Integration-AG/external-storage/commit/a49bffc5fcb157c42b1be68265be68a768215939</span><br></pre></td></tr></table></figure>


        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <section class="article-body markdown-body">
        
        <h1 id="基于Kubernetes集群部署Nginx服务"><a href="#基于Kubernetes集群部署Nginx服务" class="headerlink" title="基于Kubernetes集群部署Nginx服务"></a>基于Kubernetes集群部署Nginx服务</h1><h4 id="使用configMap定义Nginx配置信息"><a href="#使用configMap定义Nginx配置信息" class="headerlink" title="-使用configMap定义Nginx配置信息"></a>-使用configMap定义Nginx配置信息</h4><p>Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器；同时也是一个IMAP、POP3、SMTP代理服务器；Nginx可以作为一个HTTP服务器进行网站的发布处理，另外Nginx可以作为反向代理进行负载均衡的实现。</p>
<p>Nginx是最常用的代理软件，也是最常用的webserver软件，如何方便地在Kubernetes集群上部署Nginx以及如何方便的在Nginx软件之外对它进行自定义配置？</p>
<h2 id="1-自定义部署"><a href="#1-自定义部署" class="headerlink" title="1 自定义部署"></a>1 自定义部署</h2><p>在Kubernetes集群上部署Nginx可以通过yaml文件对Nginx应用进行描述，由Kubernetes集群自动解析、调度、运行及期望状态维护。</p>
<blockquote>
<p>Nginx资源定义描述示例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-agent</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-agent</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - resources:</span><br><span class="line">            limits:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.5&apos;</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.25&apos;</span><br><span class="line">          env: []</span><br><span class="line">          envFrom: []</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: nginx-plus-agent</span><br><span class="line">          image: &apos;iapcloud/nginx:latest&apos;</span><br><span class="line">          ports:</span><br><span class="line">            - name: windows-remote</span><br><span class="line">              containerPort: 3389</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /etc/nginx/</span><br><span class="line">              name: nginx-config-hgj4i</span><br><span class="line">              readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">        - configMap:</span><br><span class="line">            defaultMode: 420</span><br><span class="line">            name: nginx-config</span><br><span class="line">          name: nginx-config-hgj4i</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 20%</span><br><span class="line">      maxUnavailable: 1</span><br></pre></td></tr></table></figure>

<h2 id="2-自定义配置"><a href="#2-自定义配置" class="headerlink" title="2 自定义配置"></a>2 自定义配置</h2><p>Nginx应用能够发挥其期望作用的核心是配置，在Kubernetes集群下部署Nginx应用，可通过configMap配置注入的方式进行Nginx应用的配置自定义。通过configMap的方式，在Nginx应用启动前就能够自定义Nginx配置，该方法的优势在于配置的灵活性。在需求变更时，能够为修改提供极大的便利性。</p>
<blockquote>
<p>Nginx配置定义描述示例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |-</span><br><span class="line">    user  nginx;</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;</span><br><span class="line">    pid        /var/run/nginx.pid;</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    stream &#123;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 3389;</span><br><span class="line">     		proxy_connect_timeout 5s;</span><br><span class="line">            proxy_timeout 20s;</span><br><span class="line">            proxy_pass 192.168.22.151:3389;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Nginx应用实例关键信息解析"><a href="#3-Nginx应用实例关键信息解析" class="headerlink" title="3 Nginx应用实例关键信息解析"></a>3 Nginx应用实例关键信息解析</h2><p>（1）在Nginx配置定义描述示例中，metadata字段下的name字段描述的是Nginx配置的名称。示例Nginx配置名称为”nginx-config”，该名称将用于配置的挂载。</p>
<p>（2）在Nginx配置定义描述示例中，data字段下的键（nginx.conf为配置文件名称）；值（即冒号后内容）为Nginx应用配置的具体描述。在Nginx应用部署时，会将值内容实例化为nginx.conf文件，使Nginx应用实例能够以用户期望的方式运行。</p>
<p>（3）在Nginx资源定义描述示例中，spec.containers.volumeMounts字段描述的是Nginx配置卷的挂载信息。mountPath字段声明了Nginx实例配置文件路径（/etc/nginx）;name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i）；readOnly字段声明了configMap注入的配置信息为只读。</p>
<p>（4）在Nginx资源定义描述示例中，spec.volumes字段描述的是Nginx配置卷的信息。configMap.name字段声明了configMap注入的名称；name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i），则Nginx的configMap注入配置的数据卷挂载与数据卷之间通过数据卷名称进行关联，实现由configMap注入的Nginx配置信息挂载到Nginx示例”/etc/nginx”目录下的nginx.conf文件。</p>
<h2 id="4-Nginx部署示例"><a href="#4-Nginx部署示例" class="headerlink" title="4 Nginx部署示例"></a>4 Nginx部署示例</h2><p><strong>利用Nginx应用实例实现Windows远程连接通信转发。</strong></p>
<h3 id="4-1-Nginx应用命名空间"><a href="#4-1-Nginx应用命名空间" class="headerlink" title="4.1 Nginx应用命名空间"></a>4.1 Nginx应用命名空间</h3><p>（1）定义命名空间资源</p>
<p>nginx_ns.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br></pre></td></tr></table></figure>

<p>（2）部署命名空间资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_ns.yml</span><br><span class="line">namespace/nginx created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get ns | grep nginx</span><br><span class="line">NAME                   STATUS        AGE</span><br><span class="line">nginx                  Active        18m</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Nginx应用配置"><a href="#4-2-Nginx应用配置" class="headerlink" title="4.2 Nginx应用配置"></a>4.2 Nginx应用配置</h3><p>（1）定义应用配置资源</p>
<p>nginx_cm.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |-</span><br><span class="line">    user  nginx;</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;</span><br><span class="line">    pid        /var/run/nginx.pid;</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    stream &#123;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 3389; # 监听端口</span><br><span class="line">     		proxy_connect_timeout 5s;</span><br><span class="line">            proxy_timeout 20s;</span><br><span class="line">            proxy_pass 192.168.22.151:3389; # 转发目的地</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（2）部署应用配置资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_cm.yml</span><br><span class="line">configmap/nginx-config created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get cm -n nginx</span><br><span class="line">NAME           DATA      AGE</span><br><span class="line">nginx-config   1         12m</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Nginx应用实例"><a href="#4-3-Nginx应用实例" class="headerlink" title="4.3 Nginx应用实例"></a>4.3 Nginx应用实例</h3><p>（1）定义应用实例资源</p>
<p>nginx_dp.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-agent</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-agent</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - resources:</span><br><span class="line">            limits:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.5&apos;</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.25&apos;</span><br><span class="line">          env: []</span><br><span class="line">          envFrom: []</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: nginx-plus-agent</span><br><span class="line">          image: &apos;iapcloud/nginx:latest&apos;</span><br><span class="line">          ports:</span><br><span class="line">            - name: windows-remote</span><br><span class="line">              containerPort: 3389</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /etc/nginx/</span><br><span class="line">              name: nginx-config-hgj4i</span><br><span class="line">              readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">        - configMap:</span><br><span class="line">            defaultMode: 420</span><br><span class="line">            name: nginx-config</span><br><span class="line">          name: nginx-config-hgj4i</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 20%</span><br><span class="line">      maxUnavailable: 1</span><br></pre></td></tr></table></figure>

<p>（2）部署应用实例资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_dp.yml</span><br><span class="line">deployment.apps/nginx-agent created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get pod -n nginx</span><br><span class="line">NAME                           READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx-agent-7d84448847-q4rlr   1/1       Running   0          3m</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Nginx应用服务"><a href="#4-4-Nginx应用服务" class="headerlink" title="4.4 Nginx应用服务"></a>4.4 Nginx应用服务</h3><p>（1）定义应用服务资源</p>
<p>nginx_svc.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">  namespace: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-agent</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: 3389</span><br><span class="line">      port: 3389</span><br><span class="line">      name: windows-remote</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<p>（2）部署应用服务资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_svc.yml</span><br><span class="line">service/nginx-agent created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get svc -n nginx</span><br><span class="line">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">nginx-agent   NodePort   10.108.213.35   &lt;none&gt;        3389:35093/TCP   16s</span><br></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h2><p>上文简单介绍了什么是Nginx及其作用。同时，解释了在Kubernetes集群部署Nginx实例的资源及配置文件示例中的关键信息，即：如何通过configMap注入的方式实现部署时自定义nginx.conf配置内容。最后，以<strong>利用Nginx应用实例实现Windows远程连接通信转发</strong>这一需求，示例了在Kubernetes集群中部署Nginx应用实例的工作内容。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/18/基于Kubernetes集群部署Nginx服务-使用configMap注入修改Nginx配置信息/">基于Kubernetes集群部署Nginx服务-使用configMap注入修改Nginx配置信息</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-18T12:08:33.000Z" itemprop="datePublished">2019-09-18</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/kubernetes/">kubernetes</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器；同时也是一个IMAP、POP3、SMTP代理服务器；Nginx可以作为一个HTTP服务器进行网站的发布处理，另外Nginx可以作为反向代理进行负载均衡的实现。</p>
<p>Nginx是最常用的代理软件，也是最常用的webserver软件，如何方便地在Kubernetes集群上部署Nginx以及如何方便的在Nginx软件之外对它进行自定义配置？</p>
<h2 id="1-自定义部署"><a href="#1-自定义部署" class="headerlink" title="1 自定义部署"></a>1 自定义部署</h2><p>在Kubernetes集群上部署Nginx可以通过yaml文件对Nginx应用进行描述，由Kubernetes集群自动解析、调度、运行及期望状态维护。</p>
<blockquote>
<p>Nginx资源定义描述示例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-agent</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-agent</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - resources:</span><br><span class="line">            limits:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.5&apos;</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.25&apos;</span><br><span class="line">          env: []</span><br><span class="line">          envFrom: []</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: nginx-plus-agent</span><br><span class="line">          image: &apos;iapcloud/nginx:latest&apos;</span><br><span class="line">          ports:</span><br><span class="line">            - name: windows-remote</span><br><span class="line">              containerPort: 3389</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /etc/nginx/</span><br><span class="line">              name: nginx-config-hgj4i</span><br><span class="line">              readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">        - configMap:</span><br><span class="line">            defaultMode: 420</span><br><span class="line">            name: nginx-config</span><br><span class="line">          name: nginx-config-hgj4i</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 20%</span><br><span class="line">      maxUnavailable: 1</span><br></pre></td></tr></table></figure>

<h2 id="2-自定义配置"><a href="#2-自定义配置" class="headerlink" title="2 自定义配置"></a>2 自定义配置</h2><p>Nginx应用能够发挥其期望作用的核心是配置，在Kubernetes集群下部署Nginx应用，可通过configMap配置注入的方式进行Nginx应用的配置自定义。通过configMap的方式，在Nginx应用启动前就能够自定义Nginx配置，该方法的优势在于配置的灵活性。在需求变更时，能够为修改提供极大的便利性。</p>
<blockquote>
<p>Nginx配置定义描述示例</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |-</span><br><span class="line">    user  nginx;</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;</span><br><span class="line">    pid        /var/run/nginx.pid;</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    stream &#123;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 3389;</span><br><span class="line">     		proxy_connect_timeout 5s;</span><br><span class="line">            proxy_timeout 20s;</span><br><span class="line">            proxy_pass 192.168.22.151:3389;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Nginx应用实例关键信息解析"><a href="#3-Nginx应用实例关键信息解析" class="headerlink" title="3 Nginx应用实例关键信息解析"></a>3 Nginx应用实例关键信息解析</h2><p>（1）在Nginx配置定义描述示例中，metadata字段下的name字段描述的是Nginx配置的名称。示例Nginx配置名称为”nginx-config”，该名称将用于配置的挂载。</p>
<p>（2）在Nginx配置定义描述示例中，data字段下的键（nginx.conf为配置文件名称）；值（即冒号后内容）为Nginx应用配置的具体描述。在Nginx应用部署时，会将值内容实例化为nginx.conf文件，使Nginx应用实例能够以用户期望的方式运行。</p>
<p>（3）在Nginx资源定义描述示例中，spec.containers.volumeMounts字段描述的是Nginx配置卷的挂载信息。mountPath字段声明了Nginx实例配置文件路径（/etc/nginx）;name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i）；readOnly字段声明了configMap注入的配置信息为只读。</p>
<p>（4）在Nginx资源定义描述示例中，spec.volumes字段描述的是Nginx配置卷的信息。configMap.name字段声明了configMap注入的名称；name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i），则Nginx的configMap注入配置的数据卷挂载与数据卷之间通过数据卷名称进行关联，实现由configMap注入的Nginx配置信息挂载到Nginx示例”/etc/nginx”目录下的nginx.conf文件。</p>
<h2 id="4-Nginx部署示例"><a href="#4-Nginx部署示例" class="headerlink" title="4 Nginx部署示例"></a>4 Nginx部署示例</h2><p><strong>利用Nginx应用实例实现Windows远程连接通信转发。</strong></p>
<h3 id="4-1-Nginx应用命名空间"><a href="#4-1-Nginx应用命名空间" class="headerlink" title="4.1 Nginx应用命名空间"></a>4.1 Nginx应用命名空间</h3><p>（1）定义命名空间资源</p>
<p>nginx_ns.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br></pre></td></tr></table></figure>

<p>（2）部署命名空间资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_ns.yml</span><br><span class="line">namespace/nginx created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get ns | grep nginx</span><br><span class="line">NAME                   STATUS        AGE</span><br><span class="line">nginx                  Active        18m</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Nginx应用配置"><a href="#4-2-Nginx应用配置" class="headerlink" title="4.2 Nginx应用配置"></a>4.2 Nginx应用配置</h3><p>（1）定义应用配置资源</p>
<p>nginx_cm.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx</span><br><span class="line">data:</span><br><span class="line">  nginx.conf: |-</span><br><span class="line">    user  nginx;</span><br><span class="line">    worker_processes  1;</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;</span><br><span class="line">    pid        /var/run/nginx.pid;</span><br><span class="line">    events &#123;</span><br><span class="line">        worker_connections  1024;</span><br><span class="line">    &#125;</span><br><span class="line">    stream &#123;</span><br><span class="line">        server &#123;</span><br><span class="line">            listen 3389; # 监听端口</span><br><span class="line">     		proxy_connect_timeout 5s;</span><br><span class="line">            proxy_timeout 20s;</span><br><span class="line">            proxy_pass 192.168.22.151:3389; # 转发目的地</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（2）部署应用配置资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_cm.yml</span><br><span class="line">configmap/nginx-config created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get cm -n nginx</span><br><span class="line">NAME           DATA      AGE</span><br><span class="line">nginx-config   1         12m</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Nginx应用实例"><a href="#4-3-Nginx应用实例" class="headerlink" title="4.3 Nginx应用实例"></a>4.3 Nginx应用实例</h3><p>（1）定义应用实例资源</p>
<p>nginx_dp.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-agent</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-agent</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - resources:</span><br><span class="line">            limits:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.5&apos;</span><br><span class="line">            requests:</span><br><span class="line">              memory: 0.2Gi</span><br><span class="line">              cpu: &apos;0.25&apos;</span><br><span class="line">          env: []</span><br><span class="line">          envFrom: []</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: nginx-plus-agent</span><br><span class="line">          image: &apos;iapcloud/nginx:latest&apos;</span><br><span class="line">          ports:</span><br><span class="line">            - name: windows-remote</span><br><span class="line">              containerPort: 3389</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: /etc/nginx/</span><br><span class="line">              name: nginx-config-hgj4i</span><br><span class="line">              readOnly: true</span><br><span class="line">      volumes:</span><br><span class="line">        - configMap:</span><br><span class="line">            defaultMode: 420</span><br><span class="line">            name: nginx-config</span><br><span class="line">          name: nginx-config-hgj4i</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 20%</span><br><span class="line">      maxUnavailable: 1</span><br></pre></td></tr></table></figure>

<p>（2）部署应用实例资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_dp.yml</span><br><span class="line">deployment.apps/nginx-agent created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get pod -n nginx</span><br><span class="line">NAME                           READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx-agent-7d84448847-q4rlr   1/1       Running   0          3m</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Nginx应用服务"><a href="#4-4-Nginx应用服务" class="headerlink" title="4.4 Nginx应用服务"></a>4.4 Nginx应用服务</h3><p>（1）定义应用服务资源</p>
<p>nginx_svc.yml文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-agent</span><br><span class="line">  namespace: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-agent</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      targetPort: 3389</span><br><span class="line">      port: 3389</span><br><span class="line">      name: windows-remote</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<p>（2）部署应用服务资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 部署</span><br><span class="line">[root@k8s-m1 nginx]# kubectl create -f nginx_svc.yml</span><br><span class="line">service/nginx-agent created</span><br><span class="line"># 查询</span><br><span class="line">[root@k8s-m1 nginx]# kubectl get svc -n nginx</span><br><span class="line">NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">nginx-agent   NodePort   10.108.213.35   &lt;none&gt;        3389:35093/TCP   16s</span><br></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h2><p>上文简单介绍了什么是Nginx及其作用。同时，解释了在Kubernetes集群部署Nginx实例的资源及配置文件示例中的关键信息，即：如何通过configMap注入的方式实现部署时自定义nginx.conf配置内容。最后，以<strong>利用Nginx应用实例实现Windows远程连接通信转发</strong>这一需求，示例了在Kubernetes集群中部署Nginx应用实例的工作内容。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/09/02/Kubernetes集群节点安装Ceph客户端/">Kubernetes集群节点安装Ceph客户端</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-09-02T11:54:54.000Z" itemprop="datePublished">2019-09-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/ceph/">ceph</a>, <a class="article-tag-link" href="/tags/kubernetes/">kubernetes</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1 环境"></a>1 环境</h2><p>（1）CentOS 7.5</p>
<p>（2）Kubernetes 1.12</p>
<h2 id="2-Kubernetes集群节点配置国内yum源和epel源"><a href="#2-Kubernetes集群节点配置国内yum源和epel源" class="headerlink" title="2 Kubernetes集群节点配置国内yum源和epel源"></a>2 Kubernetes集群节点配置国内yum源和epel源</h2><p>（1）首先进入<code>/etc/yum.repos.d/</code>目录下，新建一个repo_bak目录，用于保存系统中原来的repo文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# mkdir repo_bak</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# mv *.repo repo_bak/</span><br></pre></td></tr></table></figure>

<p>（2）在CentOS中配置使用网易和阿里的开源镜像。</p>
<p>前往网易和阿里开源镜像站点下载系统对应版本的repo文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# ls</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  repo.bak</span><br></pre></td></tr></table></figure>

<p>或者手动下载repo文件并上传到<code>/etc/yum.repos.d/</code>目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 网易开源镜像站URL</span><br><span class="line"># http://mirrors.163.com/.help/centos.html</span><br><span class="line"># 阿里开源镜像站URL</span><br><span class="line"># https://opsx.alibaba.com/mirror?lang=zh-cn</span><br></pre></td></tr></table></figure>

<p>（3）清除系统yum缓存并生成新的yum缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# ls        # 列出/etc/yum.repos.d/目录下的文件</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  repo.bak</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum clean all     # 清除系统所有的yum缓存</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Cleaning repos: base extras updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum makecache     # 生成yum缓存</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">base                                                                                  | 3.6 kB  00:00:00     </span><br><span class="line">extras                                                                                | 3.4 kB  00:00:00     </span><br><span class="line">updates                                                                               | 3.4 kB  00:00:00     </span><br><span class="line">(1/12): base/7/x86_64/filelists_db                                                    | 6.7 MB  00:00:02     </span><br><span class="line">(2/12): base/7/x86_64/group_gz                                                        | 156 kB  00:00:02     </span><br><span class="line">(3/12): base/7/x86_64/other_db                                                        | 2.5 MB  00:00:01     </span><br><span class="line">(4/12): base/7/x86_64/primary_db                                                      | 5.7 MB  00:00:02     </span><br><span class="line">(5/12): extras/7/x86_64/prestodelta                                                   |  51 kB  00:00:01     </span><br><span class="line">(6/12): extras/7/x86_64/filelists_db                                                  | 494 kB  00:00:02     </span><br><span class="line">(7/12): extras/7/x86_64/other_db                                                      |  86 kB  00:00:00     </span><br><span class="line">(8/12): extras/7/x86_64/primary_db                                                    | 130 kB  00:00:01     </span><br><span class="line">(9/12): updates/7/x86_64/prestodelta                                                  | 406 kB  00:00:01     </span><br><span class="line">(10/12): updates/7/x86_64/filelists_db                                                | 2.1 MB  00:00:01     </span><br><span class="line">(11/12): updates/7/x86_64/other_db                                                    | 354 kB  00:00:00     </span><br><span class="line">(12/12): updates/7/x86_64/primary_db                                                  | 3.6 MB  00:00:01     </span><br><span class="line">Determining fastest mirrors</span><br><span class="line">Metadata Cache Created</span><br></pre></td></tr></table></figure>

<p>（4）安装epel源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum list | grep epel-release</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">epel-release.noarch                         7-9                        extras   </span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum install -y epel-release</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package epel-release.noarch 0:7-9 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================================</span><br><span class="line"> Package                       Arch                    Version                 Repository               Size</span><br><span class="line">=============================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> epel-release                  noarch                  7-9                     extras                   14 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 14 k</span><br><span class="line">Installed size: 24 k</span><br><span class="line">Downloading packages:</span><br><span class="line">epel-release-7-9.noarch.rpm                                                           |  14 kB  00:00:00     </span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : epel-release-7-9.noarch                                                                   1/1 </span><br><span class="line">  Verifying  : epel-release-7-9.noarch                                                                   1/1 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  epel-release.noarch 0:7-9                                                                                  </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@localhost yum.repos.d]# ls            # epel源安装成功，比原来多了一个epel.repo和epel-testing.repo文件</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  epel.repo  epel-testing.repo  repo.bak</span><br></pre></td></tr></table></figure>

<p>（5）使用阿里开源镜像提供的epel源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo    # 下载阿里开源镜像的epel源文件</span><br><span class="line">--2018-03-08 20:22:14--  http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">Resolving mirrors.aliyun.com (mirrors.aliyun.com)... 183.2.199.237, 113.96.109.95, 113.96.109.93, ...</span><br><span class="line">Connecting to mirrors.aliyun.com (mirrors.aliyun.com)|183.2.199.237|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1084 (1.1K) [application/octet-stream]</span><br><span class="line">Saving to: ‘/etc/yum.repos.d/epel-7.repo’</span><br><span class="line"></span><br><span class="line">100%[=================================================================================================&gt;] 1,084       --.-K/s   in 0s      </span><br><span class="line"></span><br><span class="line">2018-03-08 20:22:14 (130 MB/s) - ‘/etc/yum.repos.d/epel-7.repo’ saved [1084/1084]</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# ls</span><br><span class="line">CentOS7-Base-163.repo  Centos-7.repo  epel-7.repo  epel.repo  epel-testing.repo  repo_bak</span><br></pre></td></tr></table></figure>

<p>（6）再次清除系统yum缓存，并重新生成新的yum缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum clean all</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Cleaning repos: base epel extras updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum makecache</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">base                                                                                                                | 3.6 kB  00:00:00     </span><br><span class="line">epel                                                                                                                | 4.7 kB  00:00:00     </span><br><span class="line">extras                                                                                                              | 3.4 kB  00:00:00     </span><br><span class="line">updates                                                                                                             | 3.4 kB  00:00:00     </span><br><span class="line">(1/18): base/7/x86_64/group_gz                                                                                      | 156 kB  00:00:01     </span><br><span class="line">(2/18): base/7/x86_64/filelists_db                                                                                  | 6.7 MB  00:00:07     </span><br><span class="line">(3/18): base/7/x86_64/primary_db                                                                                    | 5.7 MB  00:00:06     </span><br><span class="line">(4/18): epel/x86_64/group_gz                                                                                        | 266 kB  00:00:01     </span><br><span class="line">(5/18): epel/x86_64/updateinfo                                                                                      | 899 kB  00:00:02     </span><br><span class="line">(6/18): epel/x86_64/prestodelta                                                                                     | 7.1 kB  00:00:00     </span><br><span class="line">(7/18): base/7/x86_64/other_db                                                                                      | 2.5 MB  00:00:05     </span><br><span class="line">(8/18): epel/x86_64/primary_db                                                                                      | 6.3 MB  00:00:04     </span><br><span class="line">(9/18): extras/7/x86_64/filelists_db                                                                                | 636 kB  00:00:00     </span><br><span class="line">(10/18): extras/7/x86_64/primary_db                                                                                 | 166 kB  00:00:00     </span><br><span class="line">(11/18): extras/7/x86_64/other_db                                                                                   | 108 kB  00:00:00     </span><br><span class="line">(12/18): extras/7/x86_64/prestodelta                                                                                | 102 kB  00:00:01     </span><br><span class="line">(13/18): epel/x86_64/other_db                                                                                       | 3.0 MB  00:00:01     </span><br><span class="line">(14/18): epel/x86_64/filelists_db                                                                                   |  10 MB  00:00:09     </span><br><span class="line">(15/18): updates/7/x86_64/filelists_db                                                                              | 3.5 MB  00:00:02     </span><br><span class="line">(16/18): updates/7/x86_64/prestodelta                                                                               | 771 kB  00:00:02     </span><br><span class="line">(17/18): updates/7/x86_64/other_db                                                                                  | 621 kB  00:00:00     </span><br><span class="line">(18/18): updates/7/x86_64/primary_db                                                                                | 6.0 MB  00:00:03     </span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">Metadata Cache Created</span><br></pre></td></tr></table></figure>

<p>（7）查看系统可用的yum源和所有的yum源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum repolist enabled</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">repo id                                            repo name                                                                         status</span><br><span class="line">base/7/x86_64                                      CentOS-7 - Base - 163.com                                                          9,591</span><br><span class="line">epel/x86_64                                        Extra Packages for Enterprise Linux 7 - x86_64                                    12,382</span><br><span class="line">extras/7/x86_64                                    CentOS-7 - Extras - 163.com                                                          390</span><br><span class="line">updates/7/x86_64                                   CentOS-7 - Updates - 163.com                                                       1,941</span><br><span class="line">repolist: 24,304</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum repolist all</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">repo id                                     repo name                                                                       status</span><br><span class="line">base/7/x86_64                               CentOS-7 - Base - 163.com                                                       enabled:  9,591</span><br><span class="line">centosplus/7/x86_64                         CentOS-7 - Plus - 163.com                                                       disabled</span><br><span class="line">contrib/7/x86_64                            CentOS-7 - Contrib - mirrors.aliyun.com                                         disabled</span><br><span class="line">epel/x86_64                                 Extra Packages for Enterprise Linux 7 - x86_64                                  enabled: 12,382</span><br><span class="line">epel-debuginfo/x86_64                       Extra Packages for Enterprise Linux 7 - x86_64 - Debug                          disabled</span><br><span class="line">epel-source                                 Extra Packages for Enterprise Linux 7 - x86_64 - Source                         disabled</span><br><span class="line">epel-testing/x86_64                         Extra Packages for Enterprise Linux 7 - Testing - x86_64                        disabled</span><br><span class="line">epel-testing-debuginfo/x86_64               Extra Packages for Enterprise Linux 7 - Testing - x86_64 - Debug                disabled</span><br><span class="line">epel-testing-source/x86_64                  Extra Packages for Enterprise Linux 7 - Testing - x86_64 - Source               disabled</span><br><span class="line">extras/7/x86_64                             CentOS-7 - Extras - 163.com                                                     enabled:    390</span><br><span class="line">updates/7/x86_64                            CentOS-7 - Updates - 163.com                                                    enabled:  1,941</span><br><span class="line">repolist: 24,304</span><br></pre></td></tr></table></figure>

<h2 id="3-安装Ceph-common（mimic版本）"><a href="#3-安装Ceph-common（mimic版本）" class="headerlink" title="3 安装Ceph-common（mimic版本）"></a>3 安装Ceph-common（mimic版本）</h2><p>为了安装速度，我们可以选用国内源。通常大家使用的国内源包括：</p>
<ul>
<li>网易 <a href="http://mirrors.163.com/ceph" target="_blank" rel="noopener"><em>http://mirrors.163.com/ceph</em></a></li>
<li>中科大 <a href="http://mirrors.ustc.edu.cn/ceph" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/ceph</a></li>
<li>阿里 <a href="http://mirrors.aliyun.com/ceph" target="_blank" rel="noopener">http://mirrors.aliyun.com/ceph</a></li>
</ul>
<p>（1）添加源。</p>
<p>给yum增加一个Ceph源(此处以网易源为例)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# tee /etc/yum.repos.d/ceph.repo &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>【注】若需要安装其它版本的ceph-common，只需将ceph.repo文件中的ceph版标识（mimic）进行更换即可。当前已知标识有：Jewel、Luminous、Mimic等。</p>
<p>（2）安装依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f /etc/yum.repos.d/dl.fedoraproject.org*</span><br></pre></td></tr></table></figure>

<p>（3）安装ceph-common。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y install ceph-common</span><br></pre></td></tr></table></figure>

<p>（4）验证ceph-common。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ceph --version</span><br><span class="line">ceph version 13.2.2 (02899bfda814146b021136e9d8e80eba494e1126) mimic （stable）</span><br></pre></td></tr></table></figure>

<h2 id="4-访问Ceph集群"><a href="#4-访问Ceph集群" class="headerlink" title="4 访问Ceph集群"></a>4 访问Ceph集群</h2><p>（1）在kubernetes集群节点主机创建/etc/ceph/目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-g3 ~]# mkdir /etc/ceph</span><br></pre></td></tr></table></figure>

<p>（2）拷贝ceph集群的ceph.client.admin.keyring和ceph.conf文件至kubernetes节点/etc/ceph目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 进入ceph集群主机/etc/ceph/目录执行拷贝命令（拷贝通过ceph-deploy实现）</span><br><span class="line">[root@ceph01 ceph]# ceph-deploy admin [k8s-node-ip]</span><br></pre></td></tr></table></figure>

<p>（3）确保该密钥环文件有读权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 进入kubernetes集群节点主机/etc/ceph/目录，对ceph.client.admin.keyring文件执行指令</span><br><span class="line">[root@ceph01 ceph]# chmod +r ceph.client.admin.keyring</span><br></pre></td></tr></table></figure>

<p>（4）访问ceph集群成功示例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-g3 ~]# rbd list</span><br><span class="line">Redis-master01-rbd-pv</span><br><span class="line">Redis-slave01-rbd-pv</span><br><span class="line">iapview-rbd-pv</span><br><span class="line">mysql-rbd-pv</span><br><span class="line">mysqlforsummer</span><br><span class="line">mysqlforsummer02</span><br><span class="line">rbd-for-rtcdb</span><br><span class="line">rbd-for-rtcdb-redis-master</span><br><span class="line">rbd-for-rtcdb-redis-slave</span><br><span class="line">rbd-for-rtcdb-redis-slave09</span><br></pre></td></tr></table></figure>

<h2 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5 参考资料"></a>5 参考资料</h2><p><a href="https://www.cnblogs.com/renpingsheng/p/7845096.html" target="_blank" rel="noopener">https://www.cnblogs.com/renpingsheng/p/7845096.html</a></p>
<p><a href="https://www.cnblogs.com/styshoo/p/8397229.html" target="_blank" rel="noopener">https://www.cnblogs.com/styshoo/p/8397229.html</a></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/08/26/安装go-ceph库/">安装go-ceph库</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-08-26T11:28:57.000Z" itemprop="datePublished">2019-08-26</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/ceph/">ceph</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="1-基础环境"><a href="#1-基础环境" class="headerlink" title="1 基础环境"></a>1 基础环境</h2><p>CentOS 7.5</p>
<p>golang 1.11</p>
<p>gcc 4.8.5 </p>
<h2 id="2-安装golang开发环境"><a href="#2-安装golang开发环境" class="headerlink" title="2 安装golang开发环境"></a>2 安装golang开发环境</h2><p>（1）进入golang下载页面，下载golang程序包（go1.11.linux-amd64.tar.gz）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL：https://studygolang.com/dl</span><br></pre></td></tr></table></figure>

<p>（2）解压golang程序包并拷贝go目录至/usr/local目录下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rados]# tar -zxvf go1.11.linux-amd64.tar.gz</span><br><span class="line">[root@localhost rados]# cp -rf go /usr/local/</span><br></pre></td></tr></table></figure>

<p>【注】拷贝时使用root帐号。</p>
<p>（3）设置环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 使用vi编辑器向/etc/profile文件尾部增加如下内容：</span><br><span class="line">export PATH=$PATH:/usr/local/go/bin</span><br><span class="line">export GOPATH=/home/iapcloud/workspace/coderepository/go</span><br><span class="line">export GOBIN=/home/iapcloud/workspace/coderepository/go/bin</span><br></pre></td></tr></table></figure>

<p>【注】GOPATH与GOBIN可以自定义设置。</p>
<p>（4）查看golang版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rados]# go version</span><br><span class="line">go version go1.11 linux/amd64</span><br></pre></td></tr></table></figure>

<p>至此，golang开发环境安装完成。</p>
<h2 id="3-安装librados2-devel库"><a href="#3-安装librados2-devel库" class="headerlink" title="3 安装librados2-devel库"></a>3 安装librados2-devel库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost rados]# yum -y install librados2-devel</span><br></pre></td></tr></table></figure>

<h2 id="4-安装ceph-common"><a href="#4-安装ceph-common" class="headerlink" title="4 安装ceph-common"></a>4 安装ceph-common</h2><p>【目的】获取rbd库，否则go-ceph将因缺少librbd.so而安装失败。</p>
<blockquote>
<p><strong>CentOS7系统配置国内yum源和epel源</strong></p>
</blockquote>
<p>（1）首先进入<code>/etc/yum.repos.d/</code>目录下，新建一个repo_bak目录，用于保存系统中原来的repo文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# mkdir repo_bak</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# mv *.repo repo_bak/</span><br></pre></td></tr></table></figure>

<p>（2）在CentOS中配置使用网易和阿里的开源镜像。</p>
<p>前往网易和阿里开源镜像站点下载系统对应版本的repo文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# wget http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# ls</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  repo.bak</span><br></pre></td></tr></table></figure>

<p>或者手动下载repo文件并上传到<code>/etc/yum.repos.d/</code>目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 网易开源镜像站URL</span><br><span class="line"># http://mirrors.163.com/.help/centos.html</span><br><span class="line"># 阿里开源镜像站URL</span><br><span class="line"># https://opsx.alibaba.com/mirror?lang=zh-cn</span><br></pre></td></tr></table></figure>

<p>（3）清除系统yum缓存并生成新的yum缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# ls        # 列出/etc/yum.repos.d/目录下的文件</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  repo.bak</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum clean all     # 清除系统所有的yum缓存</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Cleaning repos: base extras updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum makecache     # 生成yum缓存</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">base                                                                                  | 3.6 kB  00:00:00     </span><br><span class="line">extras                                                                                | 3.4 kB  00:00:00     </span><br><span class="line">updates                                                                               | 3.4 kB  00:00:00     </span><br><span class="line">(1/12): base/7/x86_64/filelists_db                                                    | 6.7 MB  00:00:02     </span><br><span class="line">(2/12): base/7/x86_64/group_gz                                                        | 156 kB  00:00:02     </span><br><span class="line">(3/12): base/7/x86_64/other_db                                                        | 2.5 MB  00:00:01     </span><br><span class="line">(4/12): base/7/x86_64/primary_db                                                      | 5.7 MB  00:00:02     </span><br><span class="line">(5/12): extras/7/x86_64/prestodelta                                                   |  51 kB  00:00:01     </span><br><span class="line">(6/12): extras/7/x86_64/filelists_db                                                  | 494 kB  00:00:02     </span><br><span class="line">(7/12): extras/7/x86_64/other_db                                                      |  86 kB  00:00:00     </span><br><span class="line">(8/12): extras/7/x86_64/primary_db                                                    | 130 kB  00:00:01     </span><br><span class="line">(9/12): updates/7/x86_64/prestodelta                                                  | 406 kB  00:00:01     </span><br><span class="line">(10/12): updates/7/x86_64/filelists_db                                                | 2.1 MB  00:00:01     </span><br><span class="line">(11/12): updates/7/x86_64/other_db                                                    | 354 kB  00:00:00     </span><br><span class="line">(12/12): updates/7/x86_64/primary_db                                                  | 3.6 MB  00:00:01     </span><br><span class="line">Determining fastest mirrors</span><br><span class="line">Metadata Cache Created</span><br></pre></td></tr></table></figure>

<p>（4）安装epel源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum list | grep epel-release</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">epel-release.noarch                         7-9                        extras   </span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum install -y epel-release</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package epel-release.noarch 0:7-9 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=============================================================================================================</span><br><span class="line"> Package                       Arch                    Version                 Repository               Size</span><br><span class="line">=============================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> epel-release                  noarch                  7-9                     extras                   14 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=============================================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 14 k</span><br><span class="line">Installed size: 24 k</span><br><span class="line">Downloading packages:</span><br><span class="line">epel-release-7-9.noarch.rpm                                                           |  14 kB  00:00:00     </span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  Installing : epel-release-7-9.noarch                                                                   1/1 </span><br><span class="line">  Verifying  : epel-release-7-9.noarch                                                                   1/1 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  epel-release.noarch 0:7-9                                                                                  </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@localhost yum.repos.d]# ls            # epel源安装成功，比原来多了一个epel.repo和epel-testing.repo文件</span><br><span class="line">Centos-7.repo  CentOS-Base-163.repo  epel.repo  epel-testing.repo  repo.bak</span><br></pre></td></tr></table></figure>

<p>（5）使用阿里开源镜像提供的epel源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo    # 下载阿里开源镜像的epel源文件</span><br><span class="line">--2018-03-08 20:22:14--  http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">Resolving mirrors.aliyun.com (mirrors.aliyun.com)... 183.2.199.237, 113.96.109.95, 113.96.109.93, ...</span><br><span class="line">Connecting to mirrors.aliyun.com (mirrors.aliyun.com)|183.2.199.237|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1084 (1.1K) [application/octet-stream]</span><br><span class="line">Saving to: ‘/etc/yum.repos.d/epel-7.repo’</span><br><span class="line"></span><br><span class="line">100%[=================================================================================================&gt;] 1,084       --.-K/s   in 0s      </span><br><span class="line"></span><br><span class="line">2018-03-08 20:22:14 (130 MB/s) - ‘/etc/yum.repos.d/epel-7.repo’ saved [1084/1084]</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# ls</span><br><span class="line">CentOS7-Base-163.repo  Centos-7.repo  epel-7.repo  epel.repo  epel-testing.repo  repo_bak</span><br></pre></td></tr></table></figure>

<p>（6）再次清除系统yum缓存，并重新生成新的yum缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum clean all</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Cleaning repos: base epel extras updates</span><br><span class="line">Cleaning up everything</span><br><span class="line">Cleaning up list of fastest mirrors</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum makecache</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">base                                                                                                                | 3.6 kB  00:00:00     </span><br><span class="line">epel                                                                                                                | 4.7 kB  00:00:00     </span><br><span class="line">extras                                                                                                              | 3.4 kB  00:00:00     </span><br><span class="line">updates                                                                                                             | 3.4 kB  00:00:00     </span><br><span class="line">(1/18): base/7/x86_64/group_gz                                                                                      | 156 kB  00:00:01     </span><br><span class="line">(2/18): base/7/x86_64/filelists_db                                                                                  | 6.7 MB  00:00:07     </span><br><span class="line">(3/18): base/7/x86_64/primary_db                                                                                    | 5.7 MB  00:00:06     </span><br><span class="line">(4/18): epel/x86_64/group_gz                                                                                        | 266 kB  00:00:01     </span><br><span class="line">(5/18): epel/x86_64/updateinfo                                                                                      | 899 kB  00:00:02     </span><br><span class="line">(6/18): epel/x86_64/prestodelta                                                                                     | 7.1 kB  00:00:00     </span><br><span class="line">(7/18): base/7/x86_64/other_db                                                                                      | 2.5 MB  00:00:05     </span><br><span class="line">(8/18): epel/x86_64/primary_db                                                                                      | 6.3 MB  00:00:04     </span><br><span class="line">(9/18): extras/7/x86_64/filelists_db                                                                                | 636 kB  00:00:00     </span><br><span class="line">(10/18): extras/7/x86_64/primary_db                                                                                 | 166 kB  00:00:00     </span><br><span class="line">(11/18): extras/7/x86_64/other_db                                                                                   | 108 kB  00:00:00     </span><br><span class="line">(12/18): extras/7/x86_64/prestodelta                                                                                | 102 kB  00:00:01     </span><br><span class="line">(13/18): epel/x86_64/other_db                                                                                       | 3.0 MB  00:00:01     </span><br><span class="line">(14/18): epel/x86_64/filelists_db                                                                                   |  10 MB  00:00:09     </span><br><span class="line">(15/18): updates/7/x86_64/filelists_db                                                                              | 3.5 MB  00:00:02     </span><br><span class="line">(16/18): updates/7/x86_64/prestodelta                                                                               | 771 kB  00:00:02     </span><br><span class="line">(17/18): updates/7/x86_64/other_db                                                                                  | 621 kB  00:00:00     </span><br><span class="line">(18/18): updates/7/x86_64/primary_db                                                                                | 6.0 MB  00:00:03     </span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">Metadata Cache Created</span><br></pre></td></tr></table></figure>

<p>（7）查看系统可用的yum源和所有的yum源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost yum.repos.d]# yum repolist enabled</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">repo id                                            repo name                                                                         status</span><br><span class="line">base/7/x86_64                                      CentOS-7 - Base - 163.com                                                          9,591</span><br><span class="line">epel/x86_64                                        Extra Packages for Enterprise Linux 7 - x86_64                                    12,382</span><br><span class="line">extras/7/x86_64                                    CentOS-7 - Extras - 163.com                                                          390</span><br><span class="line">updates/7/x86_64                                   CentOS-7 - Updates - 163.com                                                       1,941</span><br><span class="line">repolist: 24,304</span><br><span class="line"></span><br><span class="line">[root@localhost yum.repos.d]# yum repolist all</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Repository base is listed more than once in the configuration</span><br><span class="line">Repository updates is listed more than once in the configuration</span><br><span class="line">Repository extras is listed more than once in the configuration</span><br><span class="line">Repository centosplus is listed more than once in the configuration</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Repository epel-debuginfo is listed more than once in the configuration</span><br><span class="line">Repository epel-source is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * epel: mirrors.aliyun.com</span><br><span class="line">repo id                                     repo name                                                                       status</span><br><span class="line">base/7/x86_64                               CentOS-7 - Base - 163.com                                                       enabled:  9,591</span><br><span class="line">centosplus/7/x86_64                         CentOS-7 - Plus - 163.com                                                       disabled</span><br><span class="line">contrib/7/x86_64                            CentOS-7 - Contrib - mirrors.aliyun.com                                         disabled</span><br><span class="line">epel/x86_64                                 Extra Packages for Enterprise Linux 7 - x86_64                                  enabled: 12,382</span><br><span class="line">epel-debuginfo/x86_64                       Extra Packages for Enterprise Linux 7 - x86_64 - Debug                          disabled</span><br><span class="line">epel-source                                 Extra Packages for Enterprise Linux 7 - x86_64 - Source                         disabled</span><br><span class="line">epel-testing/x86_64                         Extra Packages for Enterprise Linux 7 - Testing - x86_64                        disabled</span><br><span class="line">epel-testing-debuginfo/x86_64               Extra Packages for Enterprise Linux 7 - Testing - x86_64 - Debug                disabled</span><br><span class="line">epel-testing-source/x86_64                  Extra Packages for Enterprise Linux 7 - Testing - x86_64 - Source               disabled</span><br><span class="line">extras/7/x86_64                             CentOS-7 - Extras - 163.com                                                     enabled:    390</span><br><span class="line">updates/7/x86_64                            CentOS-7 - Updates - 163.com                                                    enabled:  1,941</span><br><span class="line">repolist: 24,304</span><br></pre></td></tr></table></figure>

<p>（8）添加ceph-common安装源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# tee /etc/yum.repos.d/ceph.repo &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=http://mirrors.163.com/ceph/rpm-mimic/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.163.com/ceph/keys/release.asc</span><br><span class="line">priority=1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>（9）安装依赖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f /etc/yum.repos.d/dl.fedoraproject.org*</span><br></pre></td></tr></table></figure>

<p>（10）安装ceph-common。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum -y install ceph-common</span><br></pre></td></tr></table></figure>

<p>（11）查看ceph-common版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ceph -v</span><br><span class="line">ceph version 13.2.2 (02899bfda814146b021136e9d8e80eba494e1126) mimic (stable)</span><br></pre></td></tr></table></figure>

<h2 id="5-建立rbd库软链接"><a href="#5-建立rbd库软链接" class="headerlink" title="5 建立rbd库软链接"></a>5 建立rbd库软链接</h2><p>ceph-common安装完后，查看/usr/lib64/目录，可查找到librbd.so.1.12.0库文件。但安装go-ceph时，默认使用/usr/lib/目录下的库文件，则需要做一个库文件的软链接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ln -s /usr/lib64/librbd.so.1.12.0 /usr/lib/librbd.so</span><br></pre></td></tr></table></figure>

<h2 id="6-安装git工具"><a href="#6-安装git工具" class="headerlink" title="6 安装git工具"></a>6 安装git工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install git</span><br></pre></td></tr></table></figure>

<h2 id="7-安装go-ceph库"><a href="#7-安装go-ceph库" class="headerlink" title="7 安装go-ceph库"></a>7 安装go-ceph库</h2><p>（1）下载ceph源码，获取rbd模块头文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost iapcloud]# git clone https://github.com/ceph/ceph.git</span><br></pre></td></tr></table></figure>

<p>（2）拷贝rbd模块头文件至CentOS7.5系统/usr/include/目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查看git clone下载的ceph源码包</span><br><span class="line">[root@localhost iapcloud]# ls ceph/</span><br><span class="line">admin                     ceph.spec.in      COPYING-LGPL2.1   etc              make-dist            qa                run-make-check.sh      udev</span><br><span class="line">alpine                    cmake             debian            examples         make-srpm.sh         README.aix        selinux</span><br><span class="line">AUTHORS                   CMakeLists.txt    doc               fusetrace        man                  README.alpine.md  share</span><br><span class="line">bin                       CodingStyle       doc_deps.deb.txt  install-deps.sh  mirroring            README.FreeBSD    src</span><br><span class="line">ceph-erasure-code-corpus  CONTRIBUTING.rst  do_cmake.sh       keys             monitoring           README.md         SubmittingPatches.rst</span><br><span class="line">ceph-menv                 COPYING           do_freebsd.sh     make-apk.sh      PendingReleaseNotes  README.solaris    sudoers.d</span><br><span class="line">ceph-object-corpus        COPYING-GPL2      Doxyfile          make-debs.sh     pom.xml              README.xio        systemd</span><br><span class="line"># 拷贝rbd模块头文件</span><br><span class="line">[root@localhost iapcloud]# cp ceph/src/include/rbd /usr/include/</span><br></pre></td></tr></table></figure>

<p>（3）使用go get指令安装go-ceph库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># go get github.com/ceph/go-ceph</span><br></pre></td></tr></table></figure>

<h2 id="8-查看安装结果"><a href="#8-查看安装结果" class="headerlink" title="8 查看安装结果"></a>8 查看安装结果</h2><p>go-ceph库安装完成后，可以在GOPATH的pkg中查看到go-ceph.a静态库文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd $GOPATH</span><br><span class="line">[root@localhost golang]# ls pkg/linux_amd64/github.com/ceph/go-ceph.a</span><br><span class="line">pkg/linux_amd64/github.com/ceph/go-ceph.a</span><br></pre></td></tr></table></figure>

<p>至此，go-ceph库已安装完成。</p>
<h2 id="9-编译所需文件获取捷径"><a href="#9-编译所需文件获取捷径" class="headerlink" title="9 编译所需文件获取捷径"></a>9 编译所需文件获取捷径</h2><p>【百度网盘】</p>
<p>链接: <a href="https://pan.baidu.com/s/1Stp8aDirNyPJ66Yn5193CA" target="_blank" rel="noopener">https://pan.baidu.com/s/1Stp8aDirNyPJ66Yn5193CA</a> </p>
<p>提取码: fe5k </p>
<h2 id="【参考链接】"><a href="#【参考链接】" class="headerlink" title="【参考链接】"></a>【参考链接】</h2><p><a href="https://www.cnblogs.com/renpingsheng/p/7845096.html" target="_blank" rel="noopener">https://www.cnblogs.com/renpingsheng/p/7845096.html</a></p>
<p><a href="https://www.cnblogs.com/styshoo/p/8397229.html" target="_blank" rel="noopener">https://www.cnblogs.com/styshoo/p/8397229.html</a></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2019/08/25/基于StorageClass动态供应Kubernetes集群存储/">基于StorageClass动态供应Kubernetes集群存储(RBD)</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://yoursite.com/index.html">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-08-25T11:19:48.000Z" itemprop="datePublished">2019-08-25</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/ceph/">ceph</a>, <a class="article-tag-link" href="/tags/kubernetes/">kubernetes</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="1-存储类概述"><a href="#1-存储类概述" class="headerlink" title="1 存储类概述"></a>1 存储类概述</h2><p>Kubernetes集群管理员通过提供不同的存储类，可以满足用户不同的服务质量级别、备份策略和任意策略要求的存储需求。动态存储卷供应使用StorageClass进行实现，其允许存储卷按需被创建。如果没有动态存储供应，Kubernetes集群的管理员将不得不通过手工的方式创建新的存储卷。通过动态存储卷，Kubernetes将能够按照用户的需要，自动创建其需要的存储。</p>
<p>基于StorageClass的动态存储供应整体过程如下所示：</p>
<p><img src="/2019/08/25/基于StorageClass动态供应Kubernetes集群存储/1565921563376.png" alt="基于StorageClass的动态存储供应整体过程"></p>
<h2 id="2-定义存储类"><a href="#2-定义存储类" class="headerlink" title="2 定义存储类"></a>2 定义存储类</h2><p>每个存储类都包含：provisioner、parameters和reclaimPlolicy这三个参数域，当属于某个类的PersistentVolume需要被动态提供时，将会使用上述的参数域。</p>
<p>存储类对象的名称非常重要，用户通过对象名称请求特定的存储类。管理员创建存储类对象时，会设置类的名称和其它的参数，存储类的对象一旦被创建，将不能被更新。管理员能够为PVC指定一个默认的存储类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: standard</span><br><span class="line"># 指定存储类的供应者</span><br><span class="line">provisioner: kubernetes.io/aws-ebs</span><br><span class="line">parameters:</span><br><span class="line">  type: gp2</span><br><span class="line"># 指定回收策略</span><br><span class="line">reclaimPolicy: Retain</span><br><span class="line">mountOptions:</span><br><span class="line">  - debug</span><br></pre></td></tr></table></figure>

<h3 id="2-1-存储分配器"><a href="#2-1-存储分配器" class="headerlink" title="2.1 存储分配器"></a>2.1 存储分配器</h3><p>存储类有一个存储分配器的参数域，此参数域决定PV使用什么存储卷插件。</p>
<p>参数必需进行设置：</p>
<table>
<thead>
<tr>
<th align="left">存储卷</th>
<th align="left">内置存储分配器</th>
<th align="left">配置示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AWSElasticBlockStore</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs" target="_blank" rel="noopener">AWS EBS</a></td>
</tr>
<tr>
<td align="left">AzureFile</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#azure-file" target="_blank" rel="noopener">Azure File</a></td>
</tr>
<tr>
<td align="left">AzureDisk</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#azure-disk" target="_blank" rel="noopener">Azure Disk</a></td>
</tr>
<tr>
<td align="left">CephFS</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Cinder</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#openstack-cinder" target="_blank" rel="noopener">OpenStack Cinder</a></td>
</tr>
<tr>
<td align="left">FC</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Flexvolume</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Flocker</td>
<td align="left">✓</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">GCEPersistentDisk</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#gce-pd" target="_blank" rel="noopener">GCE PD</a></td>
</tr>
<tr>
<td align="left">Glusterfs</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#glusterfs" target="_blank" rel="noopener">Glusterfs</a></td>
</tr>
<tr>
<td align="left">iSCSI</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Quobyte</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#quobyte" target="_blank" rel="noopener">Quobyte</a></td>
</tr>
<tr>
<td align="left">NFS</td>
<td align="left">-</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">RBD</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#ceph-rbd" target="_blank" rel="noopener">Ceph RBD</a></td>
</tr>
<tr>
<td align="left">VsphereVolume</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#vsphere" target="_blank" rel="noopener">vSphere</a></td>
</tr>
<tr>
<td align="left">PortworxVolume</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#portworx-volume" target="_blank" rel="noopener">Portworx Volume</a></td>
</tr>
<tr>
<td align="left">ScaleIO</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#scaleio" target="_blank" rel="noopener">ScaleIO</a></td>
</tr>
<tr>
<td align="left">StorageOS</td>
<td align="left">✓</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#storageos" target="_blank" rel="noopener">StorageOS</a></td>
</tr>
<tr>
<td align="left">Local</td>
<td align="left">-</td>
<td align="left"><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#local" target="_blank" rel="noopener">Local</a></td>
</tr>
</tbody></table>
<p>Kubernetes的存储类并不局限于表中的“interneal”存储分配器，“interneal”存储分配器的名称带有“kubernetes.io”前缀；也可以允许和指定外部的存储分配器，外部存储分配器通过独立的程序进行实现。外部存储分配器的作者对代码在何处生存、如何供应、如何运行、使用什么卷插件（包括Flex）等有充分的判断权，kubernetes-incubator/external-storage仓库中存在编写外部存储分配器的类库。例如，NFS不是内部的存储分配器，但也是可以使用。在kubernetes-incubator/external-storage仓库中以列表的形式展示了一些外部的存储分配器，一些第三方供应商也提供了他们自己的外部存储分配器。</p>
<h3 id="2-2-参数"><a href="#2-2-参数" class="headerlink" title="2.2 参数"></a>2.2 参数</h3><p>存储类存在很多描述存储卷的参数，依赖不同的存储分配器可能有不同的参数。例如，对于type参数，它的值可能为gp2。当参数被省略，则使用默认的值。</p>
<p>Ceph分布式存储RBD示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v3</span><br><span class="line">metadata:</span><br><span class="line">  name: fast</span><br><span class="line">provisioner: kubernetes.io/rbd</span><br><span class="line">parameters:</span><br><span class="line">  monitors: 30.36.353.305:6789</span><br><span class="line">  adminId: kube</span><br><span class="line">  adminSecretName: ceph-secret</span><br><span class="line">  adminSecretNamespace: kube-system</span><br><span class="line">  pool: kube</span><br><span class="line">  userId: kube</span><br><span class="line">  userSecretName: ceph-secret-user</span><br><span class="line">  fsType: ext4</span><br><span class="line">  imageFormat: &quot;2&quot;</span><br><span class="line">  imageFeatures: &quot;layering&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>monitors：ceph monitor，逗号分隔，该参数是必需的。</li>
<li>adminId：ceph客户端ID，用于在（ceph pool）中创建镜像。默认：admin</li>
<li>adminSecretNamespace：adminSecret的namespaces。默认：default</li>
<li>adminSecret：adminId的Secret名称，该参数是必需的。提供的secret必须有值为”kubernetes.io/rbd”的type参数。</li>
<li>pool：ceph RBD池，默认是：”rbd”。</li>
<li>userId：ceph客户端ID，用于映射RBD镜像（RBD IMAGE），默认：与adminId相同。</li>
<li>userSecretName：用于映射RBD镜像的userId的ceph secret名字。它必须与PVC存在于相同的namespace中，该参数是必需的。提供的secret必须具有值为”kubernetes.io/rbd”的type参数，创建方式如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic ceph-secret --type=&quot;kubernetes.io/rbd&quot; \</span><br><span class="line">  --from-literal=key=&apos;QVFEQ1pMdFhPUnQrSmhBQUFYaERWNHJsZ3BsMmNjcDR6RFZST0E9PQ==&apos; \</span><br><span class="line">  --namespace=kube-system</span><br></pre></td></tr></table></figure>

<ul>
<li>fsType：kubernetes支持的fsType，默认：”ext4”。</li>
<li>imageFormat：ceph RBD镜像格式，”1”或”2”，默认值是”1”。</li>
<li>imageFeatures：这个参数是可选的，需要将imageFormat设置为”2”才能使用。当前支持的功能只有layering，默认：” “，功能不打开。</li>
</ul>
<h3 id="2-3-回收策略"><a href="#2-3-回收策略" class="headerlink" title="2.3 回收策略"></a>2.3 回收策略</h3><p>通过存储类创建的持久化存储卷通过reclaimPolicy参数来指定回收策略，它的值可以是Delete或者Retain，默认为Delete。对于通过手工创建的，并使用存储类进行管理的持久化存储卷，将使用任何在创建时指定的存储卷。</p>
<h3 id="2-4-挂载选项"><a href="#2-4-挂载选项" class="headerlink" title="2.4 挂载选项"></a>2.4 挂载选项</h3><p>通过存储类动态创建的持久化存储卷，会存在一个通过mountOptions参数指定的挂载选择。如果存储卷插件不支持指定的挂载选项，则分配存储就会失败，在存储类或者PV中都不会对挂载选项进行验证，因此需要在设置时进行确认。</p>
<h2 id="3-使用StorageClass"><a href="#3-使用StorageClass" class="headerlink" title="3 使用StorageClass"></a>3 使用StorageClass</h2><p>动态存储卷分配，基于StorageClass的API对象来实现，集群管理员能够按需定义StorageClass对象，每一个StorageClass对象能够指定一个存储卷插件（即存储分配器）。集群管理员能够在一个集群中定义各种存储卷分配器，用户不需要了解存储的细节和复杂性，就能够选择符合自己要求的存储。</p>
<h3 id="3-1-启用动态存储分配"><a href="#3-1-启用动态存储分配" class="headerlink" title="3.1 启用动态存储分配"></a>3.1 启用动态存储分配</h3><p>为了启用动态存储分配，集群管理员需要预先为用户创建一个或者多个存储类对象。存储类对象定义了使用哪个存储分配器，以及存储分配器相关的参数。下面是存储类的一个示例，它创建一个名称为slow的存储类，使用gce存储分配器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: slow</span><br><span class="line">provisioner: kubernetes.io/gce-pd</span><br><span class="line">parameters:</span><br><span class="line">  type: pd-standard</span><br></pre></td></tr></table></figure>

<p>下面创建了一个名为“fast”的存储类，其提供类似固态磁盘的存储卷磁盘：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: fast</span><br><span class="line">provisioner: kubernetes.io/gce-pd</span><br><span class="line">parameters:</span><br><span class="line">  type: pd-ssd</span><br></pre></td></tr></table></figure>

<h3 id="3-2-使用动态存储"><a href="#3-2-使用动态存储" class="headerlink" title="3.2 使用动态存储"></a>3.2 使用动态存储</h3><p>用户通过在PersistentVolumeClaim中包含一个存储类，来请求动态供应存储。在Kubernetes v1.6之前的版本，通过volume.beta.kubernetes.io/storage-class注释类请求动态供应存储；在v1.6版本之后，用户应该使用PersistentVolumeClaim对象的storageClassName参数来请求动态存储。</p>
<p>下面是请求fast存储类的持久化存储卷声明的YAML配置文件示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: claim1</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line"># 指定所使用的存储类，此存储类将会自动创建符合要求的PV</span><br><span class="line"> storageClassName: fast</span><br><span class="line"> resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 30Gi</span><br></pre></td></tr></table></figure>

<p>此声明将使用类似于固态存储磁盘，当持久化存储卷声明被删除后，存储卷也将会被销毁。</p>
<h3 id="3-3-默认动作"><a href="#3-3-默认动作" class="headerlink" title="3.3 默认动作"></a>3.3 默认动作</h3><p>如果Kubernetes的集群中没有指定存储类，集群管理员可以通过执行下面的设置，启用默认的存储类：</p>
<ul>
<li>标记一个默认的StorageClass对象；</li>
<li>确定API server中DefaultStorage接入控制器已被启用</li>
</ul>
<p>管理员能够通过添加storageclass.kubernetes.io/is-default-class注释，标记一个特定的StorageClass作为默认的存储类。在集群中，如果存在一个默认的StorageClass，系统将能够在不指定storageClassName 的情况下创建一个PersistentVolume，DefaultStorageClass接入控制器会自动将storageClassName指向默认的存储类。</p>
<p>注意：在一个集群中，最多只能有一个默认的存储类，如果没有默认的存储类，那么如果在PersistentVolumeClaim中没有显示指定storageClassName，则将无法创建PersistentVolume。</p>
<h2 id="4-Ceph-RBD存储类示例"><a href="#4-Ceph-RBD存储类示例" class="headerlink" title="4 Ceph RBD存储类示例"></a>4 Ceph RBD存储类示例</h2><h3 id="4-1-部署rbd-provisioner"><a href="#4-1-部署rbd-provisioner" class="headerlink" title="4.1 部署rbd-provisioner"></a>4.1 部署rbd-provisioner</h3><p>为StorageClass选择存储分配器名称，并在deployment.yaml文件内进行设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/rbd</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>rbd存储分配器实例完整部署文件内容如下所示：</strong></p>
<blockquote>
<p>ns.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph</span><br></pre></td></tr></table></figure>

<blockquote>
<p>role.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;secrets&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;endpoints&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rolebinding.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br></pre></td></tr></table></figure>

<blockquote>
<p>clusterrole.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumes&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumeclaims&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]</span><br><span class="line">  - apiGroups: [&quot;storage.k8s.io&quot;]</span><br><span class="line">    resources: [&quot;storageclasses&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;events&quot;]</span><br><span class="line">    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;services&quot;]</span><br><span class="line">    resourceNames: [&quot;kube-dns&quot;,&quot;coredns&quot;]</span><br><span class="line">    verbs: [&quot;list&quot;, &quot;get&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;endpoints&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>clusterrolebinding.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: rbd-provisioner</span><br><span class="line">    namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<blockquote>
<p>serviceaccount.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br></pre></td></tr></table></figure>

<blockquote>
<p>deployment.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: rbd-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: rbd-provisioner</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: &quot;quay.io/external_storage/rbd-provisioner:latest&quot;</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME # 定义存储分配器名称，存储类通过此名称指定存储分配器</span><br><span class="line">          value: ceph.com/rbd</span><br><span class="line">      serviceAccount: rbd-provisioner</span><br></pre></td></tr></table></figure>

<p>在kubernetes集群部署rbd-provisioner资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f ns.yaml</span><br><span class="line"># kubectl create -f role.yaml</span><br><span class="line"># kubectl create -f rolebinding.yaml</span><br><span class="line"># kubectl create -f clusterrole.yaml</span><br><span class="line"># kubectl create -f clusterrolebinding.yaml</span><br><span class="line"># kubectl create -f serviceaccount.yaml</span><br><span class="line"># kubectl create -f deployment.yaml</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Ceph集群访问授权"><a href="#4-2-Ceph集群访问授权" class="headerlink" title="4.2 Ceph集群访问授权"></a>4.2 Ceph集群访问授权</h3><p>将ceph集群访问所需的配置文件与密钥拷贝至rbd-provisioner容器实例的/etc/ceph/目录下，操作如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl cp ceph.conf &lt;rbd-provisioner-pod&gt;:/etc/ceph</span><br><span class="line"># kubectl cp ceph.client.admin.keyring &lt;rbd-provisioner-pod&gt;:/etc/ceph</span><br></pre></td></tr></table></figure>

<h3 id="4-3-创建StorageClass实例"><a href="#4-3-创建StorageClass实例" class="headerlink" title="4.3 创建StorageClass实例"></a>4.3 创建StorageClass实例</h3><p>以下是StorageClass资源配置文件，此配置文件定义了名称为standard的存储类，此存储类的分配器为ceph.com/rbd。</p>
<blockquote>
<p>defaultStorageClass.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: standard</span><br><span class="line">provisioner: ceph.com/rbd</span><br><span class="line">parameters:</span><br><span class="line">  monitors: 192.168.22.201:6789,192.168.22.202:6789,192.168.22.203:6789</span><br><span class="line">  adminId: admin</span><br><span class="line">  adminSecretName: ceph-secret</span><br><span class="line">  pool: rbd</span><br><span class="line">  userId: admin</span><br><span class="line">  userSecretName: ceph-secret</span><br><span class="line">  fsType: ext4</span><br><span class="line">  imageFormat: &quot;2&quot;</span><br><span class="line">  imageFeatures: layering</span><br></pre></td></tr></table></figure>

<p>使用StorageClass资源配置文件，通过kubectl create -f命令创建StorageClass实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f defaultStorageClass.yaml</span><br></pre></td></tr></table></figure>

<p>在存储实例被正确创建后，就可以创建PersistenetVolumeClaim来请求StorageClass，而StorageClass将会为PersistenetVolumeClaim自动创建一个可用PersistentVolume。</p>
<h3 id="4-4-创建PersistenetVolumeClaim实例"><a href="#4-4-创建PersistenetVolumeClaim实例" class="headerlink" title="4.4 创建PersistenetVolumeClaim实例"></a>4.4 创建PersistenetVolumeClaim实例</h3><p>PersistenetVolumeClaim是对PersistenetVolume的声明，即PersistenetVolume为存储的提供者，而PersistenetVolumeClaim为存储的消费者。下面是PersistentVolumeClaim的资源配置文件，此配置文件通过<em>spec.storageClassName</em>字段指定所使用的存储储类。</p>
<p>在此配置文件中，使用<em>standard</em>存储实例为PersistenetVolumeClaim创建PersistenetVolume，所要求的PersistenetVolume存储空间大小为1Gi，仅支持单个容器进行读取和写入操作。</p>
<blockquote>
<p>testStorageClass-pvc.yaml</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: fight-pvc</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: standard</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Gi</span><br></pre></td></tr></table></figure>

<p>通过kubectl create命令创建上述的持久化存储卷声明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f testStorageClass-pvc.yaml</span><br></pre></td></tr></table></figure>

<h3 id="4-5-部署使用PersistenetVolumeClaim的Pod实例"><a href="#4-5-部署使用PersistenetVolumeClaim的Pod实例" class="headerlink" title="4.5 部署使用PersistenetVolumeClaim的Pod实例"></a>4.5 部署使用PersistenetVolumeClaim的Pod实例</h3><p>定义名为testStorageClass的Pod资源配置文件，使用的镜像为busybox。基于busybox镜像的容器需要对<strong>/usr/share/busybox</strong>目录下的数据进行持久化，在YAML文件指定使用名称为fight-pvc的PersistenVolumeClaim对容器的数据进行持久化。</p>
<p>testStorageClass.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: fight</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: fight</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: fight</span><br><span class="line">        image: busybox</span><br><span class="line">        command: [&quot;sleep&quot;, &quot;60000&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /usr/share/busybox</span><br><span class="line">          name: ceph-rbd-vol1</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ceph-rbd-vol1</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">            claimName: fight-pvc</span><br></pre></td></tr></table></figure>

<p>通过kubectl create创建名为fight的部署实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f testStorageClass.yaml</span><br></pre></td></tr></table></figure>

<h2 id="5-参考文档"><a href="#5-参考文档" class="headerlink" title="5 参考文档"></a>5 参考文档</h2><ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/" target="_blank" rel="noopener">《Storage Classes》</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/" target="_blank" rel="noopener">《Dynamic Volume Provisioning》</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/ceph/rbd" target="_blank" rel="noopener">《rbd-provisioner》</a></li>
</ul>

        
    </section>
</article>





</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e5fbfff843a78216314d2466ce8003d8";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }
            
            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle();
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp();
            }, 3000);
        }
    });
    </script>
    

</body>
</html>
