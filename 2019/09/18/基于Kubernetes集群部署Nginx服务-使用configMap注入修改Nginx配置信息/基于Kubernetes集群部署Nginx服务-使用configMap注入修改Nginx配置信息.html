<h1 id="基于Kubernetes集群部署Nginx服务"><a href="#基于Kubernetes集群部署Nginx服务" class="headerlink" title="基于Kubernetes集群部署Nginx服务"></a>基于Kubernetes集群部署Nginx服务</h1><h4 id="使用configMap定义Nginx配置信息"><a href="#使用configMap定义Nginx配置信息" class="headerlink" title="-使用configMap定义Nginx配置信息"></a>-使用configMap定义Nginx配置信息</h4><p>Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器；同时也是一个IMAP、POP3、SMTP代理服务器；Nginx可以作为一个HTTP服务器进行网站的发布处理，另外Nginx可以作为反向代理进行负载均衡的实现。</p>
<p>Nginx是最常用的代理软件，也是最常用的webserver软件，如何方便地在Kubernetes集群上部署Nginx以及如何方便的在Nginx软件之外对它进行自定义配置？</p>
<h2 id="1-自定义部署"><a href="#1-自定义部署" class="headerlink" title="1 自定义部署"></a>1 自定义部署</h2><p>在Kubernetes集群上部署Nginx可以通过yaml文件对Nginx应用进行描述，由Kubernetes集群自动解析、调度、运行及期望状态维护。</p>
<blockquote>
<p>Nginx资源定义描述示例</p>
</blockquote>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-agent
spec:
  selector:
    matchLabels:
      app: nginx-agent
  template:
    metadata:
      labels:
        app: nginx-agent
    spec:
      containers:
        - resources:
            limits:
              memory: 0.2Gi
              cpu: &apos;0.5&apos;
            requests:
              memory: 0.2Gi
              cpu: &apos;0.25&apos;
          env: []
          envFrom: []
          imagePullPolicy: IfNotPresent
          name: nginx-plus-agent
          image: &apos;iapcloud/nginx:latest&apos;
          ports:
            - name: windows-remote
              containerPort: 3389
          volumeMounts:
            - mountPath: /etc/nginx/
              name: nginx-config-hgj4i
              readOnly: true
      volumes:
        - configMap:
            defaultMode: 420
            name: nginx-config
          name: nginx-config-hgj4i
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 20%
      maxUnavailable: 1</code></pre><h2 id="2-自定义配置"><a href="#2-自定义配置" class="headerlink" title="2 自定义配置"></a>2 自定义配置</h2><p>Nginx应用能够发挥其期望作用的核心是配置，在Kubernetes集群下部署Nginx应用，可通过configMap配置注入的方式进行Nginx应用的配置自定义。通过configMap的方式，在Nginx应用启动前就能够自定义Nginx配置，该方法的优势在于配置的灵活性。在需求变更时，能够为修改提供极大的便利性。</p>
<blockquote>
<p>Nginx配置定义描述示例</p>
</blockquote>
<pre><code>kind: ConfigMap
apiVersion: v1
metadata:
  name: nginx-config
  namespace: nginx
data:
  nginx.conf: |-
    user  nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {
        worker_connections  1024;
    }
    stream {
        server {
            listen 3389;
             proxy_connect_timeout 5s;
            proxy_timeout 20s;
            proxy_pass 192.168.22.151:3389;
        }
    }</code></pre><h2 id="3-Nginx应用实例关键信息解析"><a href="#3-Nginx应用实例关键信息解析" class="headerlink" title="3 Nginx应用实例关键信息解析"></a>3 Nginx应用实例关键信息解析</h2><p>（1）在Nginx配置定义描述示例中，metadata字段下的name字段描述的是Nginx配置的名称。示例Nginx配置名称为”nginx-config”，该名称将用于配置的挂载。</p>
<p>（2）在Nginx配置定义描述示例中，data字段下的键（nginx.conf为配置文件名称）；值（即冒号后内容）为Nginx应用配置的具体描述。在Nginx应用部署时，会将值内容实例化为nginx.conf文件，使Nginx应用实例能够以用户期望的方式运行。</p>
<p>（3）在Nginx资源定义描述示例中，spec.containers.volumeMounts字段描述的是Nginx配置卷的挂载信息。mountPath字段声明了Nginx实例配置文件路径（/etc/nginx）;name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i）；readOnly字段声明了configMap注入的配置信息为只读。</p>
<p>（4）在Nginx资源定义描述示例中，spec.volumes字段描述的是Nginx配置卷的信息。configMap.name字段声明了configMap注入的名称；name字段声明了configMap注入的数据卷名称（ginx-config-hgj4i），则Nginx的configMap注入配置的数据卷挂载与数据卷之间通过数据卷名称进行关联，实现由configMap注入的Nginx配置信息挂载到Nginx示例”/etc/nginx”目录下的nginx.conf文件。</p>
<h2 id="4-Nginx部署示例"><a href="#4-Nginx部署示例" class="headerlink" title="4 Nginx部署示例"></a>4 Nginx部署示例</h2><p><strong>利用Nginx应用实例实现Windows远程连接通信转发。</strong></p>
<h3 id="4-1-Nginx应用命名空间"><a href="#4-1-Nginx应用命名空间" class="headerlink" title="4.1 Nginx应用命名空间"></a>4.1 Nginx应用命名空间</h3><p>（1）定义命名空间资源</p>
<p>nginx_ns.yml文件内容如下：</p>
<pre><code>apiVersion: v1
kind: Namespace
metadata:
  name: nginx </code></pre><p>（2）部署命名空间资源</p>
<pre><code># 部署
[root@k8s-m1 nginx]# kubectl create -f nginx_ns.yml
namespace/nginx created
# 查询
[root@k8s-m1 nginx]# kubectl get ns | grep nginx
NAME                   STATUS        AGE
nginx                  Active        18m</code></pre><h3 id="4-2-Nginx应用配置"><a href="#4-2-Nginx应用配置" class="headerlink" title="4.2 Nginx应用配置"></a>4.2 Nginx应用配置</h3><p>（1）定义应用配置资源</p>
<p>nginx_cm.yml文件内容如下：</p>
<pre><code>kind: ConfigMap
apiVersion: v1
metadata:
  name: nginx-config
  namespace: nginx
data:
  nginx.conf: |-
    user  nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {
        worker_connections  1024;
    }
    stream {
        server {
            listen 3389; # 监听端口
             proxy_connect_timeout 5s;
            proxy_timeout 20s;
            proxy_pass 192.168.22.151:3389; # 转发目的地
        }
    }</code></pre><p>（2）部署应用配置资源</p>
<pre><code># 部署
[root@k8s-m1 nginx]# kubectl create -f nginx_cm.yml
configmap/nginx-config created
# 查询
[root@k8s-m1 nginx]# kubectl get cm -n nginx
NAME           DATA      AGE
nginx-config   1         12m</code></pre><h3 id="4-3-Nginx应用实例"><a href="#4-3-Nginx应用实例" class="headerlink" title="4.3 Nginx应用实例"></a>4.3 Nginx应用实例</h3><p>（1）定义应用实例资源</p>
<p>nginx_dp.yml文件内容如下：</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-agent
spec:
  selector:
    matchLabels:
      app: nginx-agent
  template:
    metadata:
      labels:
        app: nginx-agent
    spec:
      containers:
        - resources:
            limits:
              memory: 0.2Gi
              cpu: &apos;0.5&apos;
            requests:
              memory: 0.2Gi
              cpu: &apos;0.25&apos;
          env: []
          envFrom: []
          imagePullPolicy: IfNotPresent
          name: nginx-plus-agent
          image: &apos;iapcloud/nginx:latest&apos;
          ports:
            - name: windows-remote
              containerPort: 3389
          volumeMounts:
            - mountPath: /etc/nginx/
              name: nginx-config-hgj4i
              readOnly: true
      volumes:
        - configMap:
            defaultMode: 420
            name: nginx-config
          name: nginx-config-hgj4i
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 20%
      maxUnavailable: 1</code></pre><p>（2）部署应用实例资源</p>
<pre><code># 部署
[root@k8s-m1 nginx]# kubectl create -f nginx_dp.yml
deployment.apps/nginx-agent created
# 查询
[root@k8s-m1 nginx]# kubectl get pod -n nginx
NAME                           READY     STATUS    RESTARTS   AGE
nginx-agent-7d84448847-q4rlr   1/1       Running   0          3m</code></pre><h3 id="4-4-Nginx应用服务"><a href="#4-4-Nginx应用服务" class="headerlink" title="4.4 Nginx应用服务"></a>4.4 Nginx应用服务</h3><p>（1）定义应用服务资源</p>
<p>nginx_svc.yml文件内容如下：</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: nginx-agent
  namespace: nginx
spec:
  selector:
    app: nginx-agent
  ports:
    - protocol: TCP
      targetPort: 3389
      port: 3389
      name: windows-remote
  type: NodePort</code></pre><p>（2）部署应用服务资源</p>
<pre><code># 部署
[root@k8s-m1 nginx]# kubectl create -f nginx_svc.yml
service/nginx-agent created
# 查询
[root@k8s-m1 nginx]# kubectl get svc -n nginx
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
nginx-agent   NodePort   10.108.213.35   &lt;none&gt;        3389:35093/TCP   16s</code></pre><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h2><p>上文简单介绍了什么是Nginx及其作用。同时，解释了在Kubernetes集群部署Nginx实例的资源及配置文件示例中的关键信息，即：如何通过configMap注入的方式实现部署时自定义nginx.conf配置内容。最后，以<strong>利用Nginx应用实例实现Windows远程连接通信转发</strong>这一需求，示例了在Kubernetes集群中部署Nginx应用实例的工作内容。</p>
